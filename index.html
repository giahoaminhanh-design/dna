<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>B·∫£n ƒë·ªì ASEAN ‚Äî Th√¥ng tin + Ph√°t √¢m</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    *{box-sizing:border-box}html,body{margin:0;padding:0;height:100%}
    :root{--bg:#eef3f8;--ink:#0f172a;--muted:#64748b;--accent:#22c55e;--blue:#60a5fa;--stroke:#1e3a8a;--shadow:0 10px 30px rgba(2,6,23,.12)}
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{padding:20px 16px;text-align:center}
    header h1{margin:0;font-size:26px}
    .subtitle{color:var(--muted);margin-top:6px}
    main{height:calc(100% - 120px);padding:0 16px 20px;position:relative}
    #map{height:100%;width:100%;border:1px solid #cbd5e1;border-radius:14px;box-shadow:var(--shadow);background:#fff}
    .status{position:absolute;left:20px;bottom:26px;background:#111827;color:#fff;padding:8px 12px;border-radius:8px;opacity:.9;max-width:70%;font-size:12px;display:none}
    .modal.hidden{display:none}
    .modal{position:fixed;inset:0;display:grid;place-items:center;z-index:10000}
    .modal__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
    .modal__dialog{position:relative;background:#fff;border-radius:16px;box-shadow:var(--shadow);width:min(92vw,560px);padding:20px 20px 24px;animation:pop .18s ease-out}
    .modal__title{margin:4px 0 12px 0;color:var(--accent);font-size:22px;display:flex;align-items:center;gap:10px}
    .modal__close{position:absolute;right:10px;top:6px;border:0;background:transparent;font-size:28px;line-height:1;cursor:pointer}
    .info-table{width:100%;border-collapse:collapse;margin-top:6px}
    .info-table th,.info-table td{border:1px solid #e2e8f0;padding:8px 10px;text-align:left}
    .info-table th{width:140px;background:#f8fafc;color:#334155}
    .speak-btn{display:inline-flex;align-items:center;gap:6px;border:0;background:#0ea5e9;color:#fff;padding:8px 10px;border-radius:10px;cursor:pointer;box-shadow:var(--shadow)}
    .speak-btn[disabled]{opacity:.6;cursor:not-allowed}
    @keyframes pop{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
  </style>
</head>
<body>
  <header>
    <h1>B·∫¢N ƒê·ªí ASEAN ‚Äî B·∫§M ƒê·ªÇ XEM TH√îNG TIN & NGHE PH√ÅT √ÇM</h1>
    <p class="subtitle">Click v√†o qu·ªëc gia ƒë·ªÉ m·ªü b·∫£ng th√¥ng tin; c√≥ n√∫t ph√°t √¢m (Web Speech API).</p>
  </header>
  <main>
    <div id="map" role="img" aria-label="B·∫£n ƒë·ªì ƒê√¥ng Nam √Å"></div>
    <div id="status" class="status" role="status" aria-live="polite"></div>
  </main>
  <div id="modal" class="modal hidden" aria-hidden="true">
    <div class="modal__backdrop" data-close></div>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <button class="modal__close" title="ƒê√≥ng" aria-label="ƒê√≥ng" data-close>&times;</button>
      <h2 id="modal-title" class="modal__title">
        <span id="country-name"></span>
        <button id="speak-btn" class="speak-btn" title="Ph√°t √¢m t√™n & c√¢u ch√†o">
          üîä Ph√°t √¢m
        </button>
      </h2>
      <table class="info-table">
        <tr><th>Th·ªß ƒë√¥</th><td id="info-capital"></td></tr>
        <tr><th>D√¢n s·ªë</th><td id="info-population"></td></tr>
        <tr><th>Ng√¥n ng·ªØ</th><td id="info-language"></td></tr>
        <tr><th>C√¢u ch√†o</th><td id="info-greeting"></td></tr>
      </table>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const STATUS = document.getElementById('status');
    function showStatus(msg, isErr=false){ STATUS.textContent = msg; STATUS.style.display='block'; STATUS.style.background = isErr ? '#7f1d1d' : '#111827'; }
    function hideStatus(){ STATUS.style.display='none'; }

    // Data
    const INFO = {
      Vietnam:{capital:'H√† N·ªôi',population:'~100 tri·ªáu',language:'Ti·∫øng Vi·ªát',greeting:'Xin ch√†o!', voices:['vi-VN']},
      Thailand:{capital:'Bangkok',population:'~71 tri·ªáu',language:'Ti·∫øng Th√°i',greeting:'‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ!', voices:['th-TH']},
      Laos:{capital:'Vientiane',population:'~7.6 tri·ªáu',language:'Ti·∫øng L√†o',greeting:'‡∫™‡∫∞‡∫ö‡∫≤‡∫ç‡∫î‡∫µ!', voices:['lo-LA','th-TH']},
      Cambodia:{capital:'Phnom Penh',population:'~17 tri·ªáu',language:'Khmer',greeting:'·ûá·üÜ·ûö·û∂·ûî·ûü·ûΩ·ûö!', voices:['km-KH']},
      Myanmar:{capital:'Naypyidaw',population:'~55 tri·ªáu',language:'Burmese',greeting:'·Äô·ÄÑ·Ä∫·Äπ·ÄÇ·Äú·Ä¨·Äï·Ä´!', voices:['my-MM']},
      Malaysia:{capital:'Kuala Lumpur',population:'~34 tri·ªáu',language:'Malay',greeting:'Selamat datang!', voices:['ms-MY','id-ID']},
      Singapore:{capital:'Singapore',population:'~6 tri·ªáu',language:'Anh / Hoa / M√£ Lai / Tamil',greeting:'Hello!', voices:['en-SG','en-GB','en-US','zh-CN','ms-MY','ta-IN']},
      Indonesia:{capital:'Jakarta',population:'~280 tri·ªáu',language:'Bahasa Indonesia',greeting:'Halo!', voices:['id-ID']},
      Philippines:{capital:'Manila',population:'~115 tri·ªáu',language:'Filipino/English',greeting:'Mabuhay!', voices:['fil-PH','en-PH','en-US']},
      Brunei:{capital:'Bandar Seri Begawan',population:'~0.45 tri·ªáu',language:'Malay',greeting:'Selamat datang!', voices:['ms-BN','ms-MY']},
      'Timor-Leste':{capital:'Dili',population:'~1.4 tri·ªáu',language:'Tetum/Portugu√™s',greeting:'Ol√°!', voices:['pt-PT','pt-BR']}
    };
    const ISO2NAME = new Map([
      ['VNM','Vietnam'], ['THA','Thailand'], ['LAO','Laos'], ['KHM','Cambodia'],
      ['MMR','Myanmar'], ['MYS','Malaysia'], ['SGP','Singapore'], ['IDN','Indonesia'],
      ['PHL','Philippines'], ['BRN','Brunei'], ['TLS','Timor-Leste']
    ]);
    const NAME_ALIASES = new Map(Object.entries({
      'vietnam':'Vietnam','viet nam':'Vietnam',
      'thailand':'Thailand',
      'laos':'Laos','lao pdr':'Laos','lao peoples democratic republic':'Laos',"lao people's democratic republic":'Laos',
      'cambodia':'Cambodia','kingdom of cambodia':'Cambodia',
      'myanmar':'Myanmar','burma':'Myanmar',
      'malaysia':'Malaysia',
      'singapore':'Singapore',
      'indonesia':'Indonesia',
      'philippines':'Philippines',
      'brunei':'Brunei','brunei darussalam':'Brunei',
      'timor-leste':'Timor-Leste','timor leste':'Timor-Leste','east timor':'Timor-Leste'
    }));
    function normalize(s){ return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim().replace(/\s+/g,' '); }
    function codeOf(p,f){ return p.ISO_A3 || p.iso_a3 || p.ADM0_A3 || (f && f.id) || p.id || p.ISO3; }
    function pickName(p){ return p && (p.ADMIN || p.NAME || p.NAME_LONG || p.NAME_EN || p.name || p.sovereignt || p.official_name || p.official || p.country || p.country_en); }
    function displayName(p,f){ const c=codeOf(p,f); return ISO2NAME.get(c)||NAME_ALIASES.get(normalize(pickName(p)))||pickName(p)||'‚Äî'; }

    // TTS helpers (Web Speech API)
    let allVoices = [];
    function loadVoices(){ allVoices = window.speechSynthesis ? window.speechSynthesis.getVoices() : []; }
    loadVoices();
    if (window.speechSynthesis) {
      window.speechSynthesis.onvoiceschanged = loadVoices;
    }
    function pickVoice(langFallbacks=[]){
      if (!allVoices.length) loadVoices();
      for (const target of langFallbacks){
        // Exact match first
        let v = allVoices.find(v=>v.lang && v.lang.toLowerCase()===target.toLowerCase());
        if (v) return v;
        // Prefix match (e.g., en-*)
        const prefix = target.split('-')[0].toLowerCase();
        v = allVoices.find(v=>v.lang && v.lang.toLowerCase().startsWith(prefix));
        if (v) return v;
      }
      // Final fallback: any English voice
      return allVoices.find(v=>v.lang && v.lang.toLowerCase().startsWith('en')) || null;
    }
    function speakFor(country){
      const meta = INFO[country];
      if (!meta || !window.speechSynthesis) return;
      const text = country + '. ' + (meta.greeting || '');
      const u = new SpeechSynthesisUtterance(text);
      const voice = pickVoice(meta.voices || []);
      if (voice){ u.voice = voice; u.lang = voice.lang; }
      window.speechSynthesis.cancel();
      window.speechSynthesis.speak(u);
    }

    // Leaflet
    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);
    function baseStyle(){ return { color:'#1e3a8a', weight:1.2, fillColor:'#60a5fa', fillOpacity:0.7 }; }
    function activeStyle(){ return { color:'#14532d', weight:1.5, fillColor:'#22c55e', fillOpacity:0.95 }; }

    function fillInfo(country){
      const m = INFO[country] || {};
      document.getElementById('country-name').textContent = country;
      document.getElementById('info-capital').textContent = m.capital || '‚Äî';
      document.getElementById('info-population').textContent = m.population || '‚Äî';
      document.getElementById('info-language').textContent = m.language || '‚Äî';
      document.getElementById('info-greeting').textContent = m.greeting || '‚Äî';
      const btn = document.getElementById('speak-btn');
      btn.disabled = !window.speechSynthesis;
      btn.onclick = () => speakFor(country);
    }
    function openModal(country){
      fillInfo(country);
      const modal = document.getElementById('modal');
      modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false');
    }
    function closeModal(){
      const modal = document.getElementById('modal');
      modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true');
      if (window.geoLayer) window.geoLayer.eachLayer(l => { l.setStyle(baseStyle()); l._active=false; });
      if (window.speechSynthesis) window.speechSynthesis.cancel();
    }
    document.addEventListener('click', e => { if (e.target.matches('[data-close]')) closeModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    async function tryFetch(url){
      const r = await fetch(url, {mode:'cors'});
      if (!r.ok) throw new Error('HTTP '+r.status); return r.json();
    }

    (async function init(){
      showStatus('ƒêang t·∫£i world GeoJSON...');
      const sources = [
        'https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson',
        'https://cdn.jsdelivr.net/gh/datasets/geo-countries@master/data/countries.geojson',
        'https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geo.json'
      ];
      let geo=null, used='internet';
      for (const url of sources){
        try { geo = await tryFetch(url); showStatus('ƒê√£ t·∫£i: '+url); used=url; break; }
        catch(e){ /* th·ª≠ ngu·ªìn ti·∫øp theo */ }
      }
      if (!geo){ showStatus('Kh√¥ng t·∫£i ƒë∆∞·ª£c t·ª´ internet.', true); return; }

      const all = (geo.features||[]);
      let feats = all.filter(f => ISO2NAME.has(codeOf(f.properties || {}, f)));
      if (!feats.length){
        feats = all.filter(f => NAME_ALIASES.has(normalize(pickName(f.properties||{}))));
        if (feats.length) showStatus('Ngu·ªìn "'+used+'" thi·∫øu ISO3. ƒê√£ l·ªçc theo t√™n qu·ªëc gia.', true);
      }
      if (!feats.length){ showStatus('Ngu·ªìn world kh√¥ng kh·ªõp ASEAN.', true); return; }

      window.geoLayer = L.geoJSON({type:'FeatureCollection', features:feats}, {
        style: baseStyle,
        onEachFeature: (feature, layer) => {
          const country = displayName(feature.properties || {}, feature);
          layer.bindTooltip(country, {sticky:true, opacity:0.9});
          layer.on('click', () => {
            window.geoLayer.eachLayer(l => { l.setStyle(baseStyle()); l._active=false; });
            layer.setStyle(activeStyle()); layer._active=true; if (layer.bringToFront) layer.bringToFront();
            openModal(country);
          });
          layer.on('mouseover', ()=>{ if (!layer._active) layer.setStyle({ fillOpacity: 0.85 }); });
          layer.on('mouseout',  ()=>{ if (!layer._active) layer.setStyle({ fillOpacity: 0.7  }); });
          layer.once('add', () => {
            const el = layer.getElement(); if (!el) return;
            el.setAttribute('tabindex','0');
            el.setAttribute('role','button');
            el.setAttribute('aria-label', country);
            el.addEventListener('keydown', (ev) => {
              if (ev.key === 'Enter' || ev.key === ' ') { layer.fire('click'); }
            });
          });
        }
      }).addTo(map);

      map.fitBounds(window.geoLayer.getBounds(), { padding:[20,20] });
      map.on('click', () => closeModal());

      showStatus('Xong! B·∫•m qu·ªëc gia ƒë·ªÉ xem & nghe.'); setTimeout(hideStatus, 2200);
    })();
  </script>
</body>
</html>

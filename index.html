<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Bản đồ Đông Nam Á — robust (ISO3 + fallback tên) | có Hoàng Sa & Trường Sa</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    *{box-sizing:border-box}html,body{margin:0;padding:0;height:100%}
    :root{--bg:#f1f5f9;--card:#ffffff;--ink:#0f172a;--muted:#64748b;--accent:#22c55e;--blue:#60a5fa;--stroke:#1e3a8a;--shadow:0 10px 30px rgba(2,6,23,.15)}
    body{font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:var(--bg);color:var(--ink)}
    header{padding:20px 16px;text-align:center}
    header h1{margin:0;font-size:26px}
    .subtitle{color:var(--muted);margin-top:6px}
    main{height:calc(100% - 120px);padding:0 16px 20px;position:relative}
    #map{height:100%;width:100%;border:1px solid #cbd5e1;border-radius:14px;box-shadow:var(--shadow);background:#fff}
    .status{position:absolute;left:20px;bottom:26px;background:#111827;color:#fff;padding:8px 12px;border-radius:8px;opacity:.9;max-width:70%;font-size:12px;display:none}
    footer{padding:12px;text-align:center;color:var(--muted)}
    .modal.hidden{display:none}
    .modal{position:fixed;inset:0;display:grid;place-items:center;z-index:10000}
    .modal__backdrop{position:absolute;inset:0;background:rgba(0,0,0,.45)}
    .modal__dialog{position:relative;background:#fff;border-radius:16px;box-shadow:var(--shadow);width:min(90vw,520px);padding:20px 20px 24px;animation:pop .18s ease-out}
    .modal__title{margin:4px 0 12px 0;color:var(--accent);font-size:22px}
    .modal__close{position:absolute;right:10px;top:6px;border:0;background:transparent;font-size:28px;line-height:1;cursor:pointer}
    @keyframes pop{from{opacity:0;transform:scale(.96)}to{opacity:1;transform:scale(1)}}
    .disclaimer{position:absolute;right:16px;bottom:16px;background:#fff;border:1px dashed #94a3b8;border-radius:10px;padding:8px 12px;font-size:12px;color:#475569;max-width:360px}
  </style>
</head>
<body>
  <header>
    <h1>BẢN ĐỒ ĐÔNG NAM Á — ROBUST</h1>
    <p class="subtitle">Lọc theo ISO_A3; nếu thiếu thì fallback theo tên (đa biến thể). Có khung ước lệ Hoàng Sa & Trường Sa.</p>
  </header>

  <main>
    <div id="map" role="img" aria-label="Bản đồ Đông Nam Á"></div>
    <div id="status" class="status" role="status" aria-live="polite"></div>
    <div class="disclaimer">Khu vực quần đảo được vẽ dưới dạng khung phạm vi <em>ước lệ</em> để đảm bảo hiển thị; không thể hiện ranh giới pháp lý.</div>
  </main>

  <div id="modal" class="modal hidden" aria-hidden="true">
    <div class="modal__backdrop" data-close></div>
    <div class="modal__dialog" role="dialog" aria-modal="true" aria-labelledby="modal-title">
      <button class="modal__close" title="Đóng" aria-label="Đóng" data-close>&times;</button>
      <h2 id="modal-title" class="modal__title"></h2>
      <div class="modal__body">
        <p><strong>Dân số:</strong> <span id="info-population"></span></p>
        <p><strong>Ngôn ngữ:</strong> <span id="info-language"></span></p>
        <p><strong>Văn hoá:</strong> <span id="info-culture"></span></p>
      </div>
    </div>
  </div>

  <footer>Deploy thẳng GitHub Pages • 1 trang HTML</footer>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    const STATUS = document.getElementById('status');
    function showStatus(msg, isErr=false){ STATUS.textContent = msg; STATUS.style.display='block'; STATUS.style.background = isErr ? '#7f1d1d' : '#111827'; }
    function hideStatus(){ STATUS.style.display='none'; }

    // Thông tin hiển thị
    const INFO = {
      Vietnam:{population:'~100 triệu',language:'Tiếng Việt',culture:'Á Đông + Pháp; gồm đất liền & các quần đảo ngoài khơi'},
      Thailand:{population:'~71 triệu',language:'Tiếng Thái',culture:'Phật giáo, hoàng gia'},
      Laos:{population:'~7.6 triệu',language:'Tiếng Lào',culture:'Theravada'},
      Cambodia:{population:'~17 triệu',language:'Khmer',culture:'Angkor'},
      Myanmar:{population:'~55 triệu',language:'Burmese',culture:'Đa dân tộc'},
      Malaysia:{population:'~34 triệu',language:'Bahasa',culture:'Hồi giáo, đa tộc'},
      Singapore:{population:'~6 triệu',language:'Anh/Hoa/ML/Tamil',culture:'Đa văn hoá'},
      Indonesia:{population:'~280 triệu',language:'Bahasa',culture:'Quần đảo đa ngữ'},
      Philippines:{population:'~115 triệu',language:'Filipino/Anh',culture:'TBN + Mỹ'},
      Brunei:{population:'~0.45 triệu',language:'Malay',culture:'Hồi giáo'},
      'Timor-Leste':{population:'~1.4 triệu',language:'Tetum/Bồ',culture:'Đông Timor'}
    };

    // Ánh xạ ISO_A3 -> tên hiển thị (khớp với keys của INFO)
    const ISO2NAME = new Map([
      ['VNM','Vietnam'], ['THA','Thailand'], ['LAO','Laos'], ['KHM','Cambodia'],
      ['MMR','Myanmar'], ['MYS','Malaysia'], ['SGP','Singapore'], ['IDN','Indonesia'],
      ['PHL','Philippines'], ['BRN','Brunei'], ['TLS','Timor-Leste']
    ]);

    // Fallback theo tên (đa biến thể)
    const NAME_ALIASES = new Map(Object.entries({
      'vietnam':'Vietnam','viet nam':'Vietnam','vn':'Vietnam',
      'thailand':'Thailand','kingdom of thailand':'Thailand',
      'laos':'Laos','lao pdr':'Laos','lao people\'s democratic republic':'Laos','lao peoples democratic republic':'Laos','lao':'Laos',
      'cambodia':'Cambodia','kingdom of cambodia':'Cambodia','khmer':'Cambodia',
      'myanmar':'Myanmar','burma':'Myanmar','republic of the union of myanmar':'Myanmar',
      'malaysia':'Malaysia',
      'singapore':'Singapore','republic of singapore':'Singapore',
      'indonesia':'Indonesia','republic of indonesia':'Indonesia',
      'philippines':'Philippines','republic of the philippines':'Philippines',
      'brunei':'Brunei','brunei darussalam':'Brunei','state of brunei darussalam':'Brunei',
      'timor-leste':'Timor-Leste','timor leste':'Timor-Leste','east timor':'Timor-Leste','democratic republic of timor-leste':'Timor-Leste'
    }));

    const map = L.map('map');
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'&copy; OpenStreetMap'}).addTo(map);

    function baseStyle(){ return { color:'#1e3a8a', weight:1.2, fillColor:'#60a5fa', fillOpacity:0.7 }; }
    function activeStyle(){ return { color:'#14532d', weight:1.5, fillColor:'#22c55e', fillOpacity:0.95 }; }

    // Helpers để bền vững giữa các nguồn dữ liệu
    function codeOf(props, feature){
      return props.ISO_A3 || props.iso_a3 || props.ADM0_A3 || (feature && feature.id) || props.id || props.ISO3;
    }
    function pickName(props){
      return props && (props.ADMIN || props.NAME || props.NAME_LONG || props.NAME_EN || props.name || props.sovereignt || props.official_name || props.official || props.country || props.country_en);
    }
    function normalize(s){
      return (s||'').toString().normalize('NFD').replace(/[\u0300-\u036f]/g,'').toLowerCase().trim().replace(/\s+/g,' ');
    }
    function displayName(props, feature){
      const code = codeOf(props, feature);
      return ISO2NAME.get(code) || NAME_ALIASES.get(normalize(pickName(props))) || pickName(props) || '—';
    }

    function openModal(name){
      const m = INFO[name] || {population:'—', language:'—', culture:'—'};
      document.getElementById('modal-title').textContent = name;
      document.getElementById('info-population').textContent = m.population;
      document.getElementById('info-language').textContent = m.language;
      document.getElementById('info-culture').textContent = m.culture;
      const modal = document.getElementById('modal');
      modal.classList.remove('hidden'); modal.setAttribute('aria-hidden','false');
    }
    function closeModal(){
      const modal = document.getElementById('modal');
      modal.classList.add('hidden'); modal.setAttribute('aria-hidden','true');
      if (window.geoLayer) window.geoLayer.eachLayer(l => { l.setStyle(baseStyle()); l._active=false; });
    }
    document.addEventListener('click', e => { if (e.target.matches('[data-close]')) closeModal(); });
    document.addEventListener('keydown', e => { if (e.key === 'Escape') closeModal(); });

    async function tryFetch(url){
      const r = await fetch(url, {mode:'cors'});
      if (!r.ok) throw new Error('HTTP '+r.status); return r.json();
    }

    // === Vẽ khung ước lệ cho Hoàng Sa, Trường Sa (dạng polygon nét đứt) ===
    const ARCHIPELAGO_BOXES = {
      "Quần đảo Hoàng Sa": {
        polygon: [[ [111.0, 16.0],[113.5, 16.0],[113.5, 17.8],[111.0, 17.8],[111.0, 16.0] ]],
        center: [16.9, 112.2]
      },
      "Quần đảo Trường Sa": {
        polygon: [[ [111.0, 7.0],[118.0, 7.0],[118.0, 12.5],[111.0, 12.5],[111.0, 7.0] ]],
        center: [10.0, 114.5]
      }
    };
    function addArchipelagoBoxes(map){
      const group = L.featureGroup();
      Object.entries(ARCHIPELAGO_BOXES).forEach(([label, conf]) => {
        const layer = L.polygon(conf.polygon, { color:'#0f172a', weight:1.2, fillColor:'#94a3b8', fillOpacity:0.15, dashArray:'6 4' })
          .bindTooltip(label + ' (ước lệ)', {sticky:true, opacity:0.9});
        layer.on('click', () => openModal('Vietnam'));
        group.addLayer(layer);
        const marker = L.circleMarker(conf.center, {radius:3, color:'#0f172a', weight:1, fillOpacity:0.8});
        marker.bindTooltip(label, {permanent:false, direction:'top'});
        marker.on('click', () => openModal('Vietnam'));
        group.addLayer(marker);
      });
      group.addTo(map);
      return group;
    }

    (async function init(){
      showStatus('Đang tải dữ liệu biên giới...');
      const sources = [
        'https://raw.githubusercontent.com/datasets/geo-countries/master/data/countries.geojson',
        'https://cdn.jsdelivr.net/gh/datasets/geo-countries@master/data/countries.geojson',
        'https://raw.githubusercontent.com/johan/world.geo.json/master/countries.geojson',
      ];
      let geo=null, used='internet';
      for (const url of sources){
        try { geo = await tryFetch(url); showStatus('Tải từ: '+url); used = url; break; }
        catch(e){ /* thử nguồn tiếp theo */ }
      }
      if (!geo){
        showStatus('Không tải được GeoJSON từ internet. Dùng file local: asean.geojson', true);
        try { const local = await tryFetch('./asean.geojson'); geo = local; used='local'; }
        catch(e){ showStatus('Thiếu cả asean.geojson. Upload file đó vào repo nhé.', true); return; }
      }

      const all = (geo.features||[]);
      // 1) Lọc theo ISO3
      let feats = all.filter(f => ISO2NAME.has(codeOf(f.properties || {}, f)));

      // 2) Nếu rỗng, fallback theo tên (đa biến thể)
      if (!feats.length){
        feats = all.filter(f => {
          const p = f.properties || {};
          const n = normalize(pickName(p));
          return NAME_ALIASES.has(n);
        });
        if (feats.length) showStatus('Nguồn "'+used+'" thiếu ISO3. Đã fallback theo tên quốc gia.', true);
      }

      // 3) Nếu vẫn rỗng nhưng tổng số feature nhỏ (<=20), assume file đã là ASEAN subset
      if (!feats.length && all.length && all.length <= 20){
        feats = all;
        showStatus('Không nhận diện được tên/ISO3. Dùng toàn bộ features trong file (<=20) như ASEAN.', true);
      }

      if (!feats.length){
        showStatus('GeoJSON không khớp ASEAN (thiếu ISO3 & tên). Cần cung cấp asean.geojson đã lọc.', true);
        return;
      }

      window.geoLayer = L.geoJSON({type:'FeatureCollection', features:feats}, {
        style: baseStyle,
        onEachFeature: (feature, layer) => {
          const label = displayName(feature.properties || {}, feature);
          layer.bindTooltip(label, {sticky:true, opacity:0.9});
          layer.on('click', () => {
            window.geoLayer.eachLayer(l => { l.setStyle(baseStyle()); l._active=false; });
            layer.setStyle(activeStyle()); layer._active=true; if (layer.bringToFront) layer.bringToFront();
            openModal(label);
          });
          layer.on('mouseover', ()=>{ if (!layer._active) layer.setStyle({ fillOpacity: 0.85 }); });
          layer.on('mouseout',  ()=>{ if (!layer._active) layer.setStyle({ fillOpacity: 0.7  }); });

          // A11y: cho phép Tab + Enter/Space để mở modal
          layer.once('add', () => {
            const el = layer.getElement(); if (!el) return;
            el.setAttribute('tabindex','0'); el.setAttribute('role','button'); el.setAttribute('aria-label', label);
            el.addEventListener('keydown', (ev) => { if (ev.key === 'Enter' || ev.key === ' ') { layer.fire('click'); } });
          });
        }
      }).addTo(map);

      // Thêm khung ước lệ cho hai quần đảo
      const archGroup = addArchipelagoBoxes(map);

      // Fit map để nhìn thấy cả phần đất liền và hai quần đảo
      const bounds = window.geoLayer.getBounds().extend(archGroup.getBounds());
      map.fitBounds(bounds, { padding:[20,20] });

      // Đóng modal khi click ra vùng trống
      map.on('click', () => closeModal());

      showStatus('Tải xong. Click quốc gia hoặc khung quần đảo để xem thông tin.');
      setTimeout(hideStatus, 2500);
    })();
  </script>
</body>
</html>
